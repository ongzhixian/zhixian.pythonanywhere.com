{% extends "_layouts/_home.html" %}

{% block title %}Portfolio detail{% endblock %}

{% block head_link %}{% endblock %}

{% block content %}

<div class="page-content">

  <!-- <div class="breadcrumb inline">
    <a href="/shared-data/dashboard">Dashboard</a>
    <span class="material-icons">chevron_right</span>
    <span>Market identifier codes</span>
  </div> -->

  

  <div class="container">

    <!-- <p>Work-in-progress</p> -->

    <!-- <div class="row portfolio-summary">
      <p>TODO: Some kind of summary</p>
    </div> -->

    <!-- <hr style="border: 2px dotted grey"/> -->
<!-- 
    <div class="row portfolio-positions">
      <div class="col-md-12">
        <h3>Positions</h3>


      </div>
    </div> -->

    <!-- <div class="row portfolio-history">
      <div class="col-md-12">
        <h3>History</h3>
        <p>This portfolio has no history.</p>
      </div>
    </div> -->

    <div class="row">
      <div class="col s12">
        <ul class="tabs">
          <li class="tab col s2"><a href="#alerts" class="active" class="blue-text">Alerts</a></li>
          <li class="tab col s2"><a href="#positions" class="blue-text">Positions</a></li>
          <li class="tab col s2"><a href="#history">History</a></li>
          <!-- <li class="tab col s3 disabled"><a href="#test3">Disabled Tab</a></li> -->
        </ul>
      </div>
      <div id="alerts" class="col s12">
        <p>This portfolio has no alerts.</p>
      </div><!-- end of alerts tab -->
      <div id="positions" class="col s12">
        <div class="action">
          <a class="btn waves-effect waves-light modal-trigger blue" href="#add-transation-modal" type="submit" name="action" title="Add position" style="float: right;">Add transaction
            <i class="material-icons left">add</i> 
          </a>
        </div>

        {% if position_list %}
        <table>
          <thead>
            <tr>
                <th>Name</th>
                <th>Unit</th>
                <th>Price</th>
                <th>Value</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>SomeISIN1</td>
              <td>1</td>
              <td>$0.87</td>
              <td>$0.87</td>
            </tr>
            <tr>
              <td>SomeISIN2</td>
              <td>1</td>
              <td>$0.87</td>
              <td>$3.76</td>
            </tr>
            <tr>
              <td>SomeISIN3</td>
              <td>1</td>
              <td>$0.87</td>
              <td>$7.00</td>
            </tr>
          </tbody>
        </table>
        {% else %}
        <p>This portfolio has no positions.</p>
        {% endif %}

      <!-- Modal Trigger -->
      <!-- <a class="waves-effect waves-light btn modal-trigger" href="#modal1">Modal</a> -->

      <!-- Modal Structure -->
      <div id="add-transation-modal" class="modal">
        
          <div class="modal-content">
            <h4>Add transaction</h4>
            <div class="container" style="width: 100%;">

              <div class="row">

                <div class="input-field col s3">
                  <input type="text" id="isin_field" name="isin_field" class="autocomplete validate">
                  <label for="isin_field">ISIN</label>
                </div>

                <div class="col s9"></div>

              </div>

              <p>A bunch of text</p>
            </div>
          </div>
          <hr style="margin: 0 2em; color:gray"/>
          <div class="modal-footer">
            <a class="modal-close waves-effect waves-red btn-flat">Cancel</a>
            <button type="button" class="modal-close waves-effect waves-green btn-flat">Add</a>
          </div>
        
      </div>


      </div><!-- end of positions tab -->
      <div id="history" class="col s12">
        <p>This portfolio has no history.</p>
      </div><!-- end of history tab -->

      <!-- <div id="test3" class="col s12">Test 3</div> -->
    </div>
          

  </div>

  <div class="fixed-action-btn">
    <a class="btn-floating btn-large blue"><i class="large material-icons">mode_edit</i></a>
    <ul>
      <li><a class="btn-floating red"><i class="material-icons">insert_chart</i></a></li>
      <li><a class="btn-floating yellow darken-1"><i class="material-icons">format_quote</i></a></li>
      <li><a class="btn-floating green"><i class="material-icons">publish</i></a></li>
      <li><a class="btn-floating blue"><i class="material-icons">attach_file</i></a></li>
    </ul>
  </div>

</div>

{% endblock %}

{% block scripts %}
<script type="text/javascript">
  document.addEventListener('DOMContentLoaded', function() {
    var elems = document.querySelectorAll('select');
    var instances = M.FormSelect.init(elems);

    var autocomplete_elems = document.querySelectorAll('.autocomplete');
    var autocomplete_instances = M.Autocomplete.init(autocomplete_elems, {
      data: {
        "Apple": null,
        "Microsoft": null,
        "Google": 'https://placehold.it/250x250'
      },
      minLength: 2,
      onAutocomplete: function() {
       console.log('Selected an option');
      }
    });

    var modal_elems = document.querySelectorAll('.modal');
    var modal_instances = M.Modal.init(modal_elems);

    var elems = document.querySelectorAll('.fixed-action-btn');
    var instances = M.FloatingActionButton.init(elems);

    var el = document.querySelectorAll('.tabs');
    var tabs_instance = M.Tabs.init(el);

    const isin_field_element = document.getElementById("isin_field");
    var isin_autocomplete = M.Autocomplete.getInstance(isin_field_element);
    document.getElementById("isin_field").addEventListener("change", ()=> {
      console.log("change"); // When selected; same effect as setting onAutocomplete
    });

    document.getElementById("isin_field").addEventListener("input", performSearch);

  });

  function searchAjaxCall() {
    
    console.log('ajax search');
    // document.getElementById("search_form").submit();

    var data = JSON.stringify({
      "isin": document.getElementById("isin_field").value
    });
    
    //console.log("So some kind of search");
    let url = '/api/test/oda';

    fetch(url)
    .then(function(response) {
      // handle the response
      return response.json();
    })
    .then(function(data) {
      // handle the data
      
      console.log(data);

      var dataMap = {};
      data.instruments.map(function (val, idx, array) {
        dataMap[val.displayName] = null;
      });

      const isin_field_element = document.getElementById("isin_field");
      var instance = M.Autocomplete.getInstance(isin_field_element);
      instance.updateData(dataMap);
    })
    .catch(function() {
      // handle the error
    });
  }

  let timeOutId;
  function performSearch() {

    if (timeOutId) {
      clearTimeout(timeOutId);
      timeOutId = null;
    }

    timeOutId = setTimeout(() => {
      searchAjaxCall();

      clearTimeout(timeOutId);
      timeOutId = null;
    }, 678);

    


    // fetch('/api/instrument/search', {
    //   method: 'POST', // *GET, POST, PUT, DELETE, etc.
    //   headers: {
    //     'Content-Type': 'application/json' // 'Content-Type': 'application/x-www-form-urlencoded',
    //   },
    //   body: JSON.stringify(data) // body data type must match "Content-Type" header
    // }).then(response => {
    //   debugger;
    //   response.body.getReader().read()
    //   var s = response.json();
    //   const isin_field_element = document.getElementById("isin_field");
    //   var instance = M.Autocomplete.getInstance(isin_field_element);
    //   instance.updateData({
    //     "FakeApple": null,
    //     "FakeMicrosoft": null,
    //     "FakeGoogle": 'https://placehold.it/250x250'
    //   });
    // });

    
  }


</script>
{% endblock %}