{% extends "_layouts/_home.html" %}

{% block title %}Database update{% endblock %}

{% block head_link %}
<link rel="stylesheet" href="/css/mdl/material.min.css" />
<link rel="stylesheet" href="/css/mdl/material.min.css" />{% endblock %}

{% block content %}

<div class="page-content">

    <!--
    What do we want to do here on this page?
    1.  Display a list of unapplied updates
    2.  Click to apply updates
    -->
    <div class="breadcrumb inline">
        <a href="/database/dashboard"> Dashboard</a>
        <span class="material-icons">chevron_right</span>
        <span>Table updates</span>
    </div>

    <!-- <span class="material-icons">arrow_back</span> -->

    <!-- <div>&nbsp;</div> -->

    <table class="mdl-data-table mdl-js-data-table mdl-data-table--selectable mdl-shadow--2dp">
        <thead>
            <tr>
                <th class="mdl-data-table__cell--non-numeric">Update</th>
                <th>Quantity</th>
            </tr>
        </thead>
        <tbody>
            {%- for update in model.updates %}
            <tr data-record="{{ update[0] }}">
                <td class="mdl-data-table__cell--non-numeric">{{ update[1] }}</td>
                <td>{{ update[2] }}</td>
            </tr>
            {%- endfor %}
        </tbody>
    </table>

    <div>&nbsp;</div>

    <div class="action-panel">
        <form method="post" action="/database/apply-update" onsubmit="applyUpdates()" class="inline">
            <button type="submit" id="applyUpdatesButton" name="action" value="apply-update"
                class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect" disabled>Apply updates</button>
            <input type="hidden" name="updateIdList" id="updateIdList" value="" />
        </form>
        
        
    </div>

</div>

{% endblock %}

{% block scripts %}
<script src="/js/mdl-enhancements/mdl-enhancements.js" type="text/javascript"></script>
<script src="/js/jquery/jquery-3.5.1.min.js" type="text/javascript"></script>
<script type="text/javascript">
    "use strict";

    function applyUpdates() {
        
        var selectedIds = $(".mdl-checkbox__input:checked")
            .toArray()
            .filter(ele => ele.hasAttribute("value"))
            .map(ele => {
                return ele.value;
            }).join(",");

        if (selectedIds.length > 0) {
            console.info("selectedIds", selectedIds);
            $("#updateIdList").val(selectedIds);
            return true;
        }
        
        return false;
    }

    (function ($) {

        function toggleApplyUpdateButton(event) {
            // Enable apply button if something is checked
            // Disable apply button if nothing is checked
            let isSomethingChecked = $(".mdl-checkbox__input:checked").length > 0;
            let applyUpdatesButton = $("#applyUpdatesButton")[0].MaterialButton;

            isSomethingChecked ? applyUpdatesButton.enable() : applyUpdatesButton.disable();
        }

        $(document).on("change", ".mdl-checkbox__input", toggleApplyUpdateButton);

        // $("#applyUpdatesButton").on("click", function(e) {
        //     debugger;
        // });


    }(jQuery));

</script>

{% endblock %}