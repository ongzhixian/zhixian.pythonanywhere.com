{% extends "_layouts/_home.html" %}

{% block title %}Feature dashboard{% endblock %}

{% block head_link %}{% endblock %}

{% block content %}

<div class="page-content">

  <div class="container">

    <div class="row">

      <div class="col s12">
        <form method="post">
          <div class="col s12">
            <div class="input-field inline">
              <input type="text" id="feature_name_field" name="feature_name_field" value="{{search_term}}">
              <label for="feature_name_field">Feature name</label>
            </div>
          </div>
        </form>

        {% if feature_list %}

        <table>
          <thead>
            <tr>
                <th>s/n</th>
                <th>Name</th>
                <th>Description</th>
                <th>Is enable</th>
            </tr>
          </thead>
          <tbody>
      
            {% for feature in feature_list %}
            <tr>
              <td>{{loop.index}}</td>
              <td>
                <a href="/feature/option/{{feature[1] | replace(' ', '-') | lower }}" >
                  <span class="material-icons" style="vertical-align: middle;">settings</span>
                </a>

                <a href="/feature/{{ feature[1] | replace(' ', '-') | lower }}" style="vertical-align: middle;">{{feature[1]}}</a>
              </td>
              <td>{{feature[2]}}</td>
              <td>
                <div class="switch">
                  <label>
                    Disable 
                    <input type="checkbox" class="toggle" {%- if feature[4] %} checked {% endif %} 
                    id="{{feature[1]|lower}}-enable"
                    name="{{feature[1]|lower}}-enable"
                    data-feature-name="{{feature[1]}}">
                    <span class="lever"></span>
                    Enabled
                  </label>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        {% else %}

        {% if search_term %}
        <p>No features with {{search_term}} found.</p>
        {% else %}
        <p>No features found.</p>
        {% endif %}

        

        {% endif %}
      </div>

    </div>
    
  </div>


  <div class="card-holder container row">
    <div class="display-card col s3">
      <div class="card-panel blue-grey lighten-5">
        <div class="header">
          <span class="title">Note</span>
        </div>
        <p class="blue-grey-text">
          Yeah this is stupid too. ðŸ¤”
        </p>
        <p class="blue-grey-text">
          The features should be automatically registered as part of the process.
        </p>
      </div>  
    </div>
  </div>

</div><!-- end of page-content -->

<!-- <div id="notification-toast" class="mdl-js-snackbar mdl-snackbar">
  <div class="mdl-snackbar__text"></div>
  <button class="mdl-snackbar__action" type="button" title="notification-toast"></button>
</div> -->

<!-- <a onclick="M.toast({html: 'I am a toast'})" class="btn">Toast!</a> -->

<form method="post" id="toggle_update_form">
  <input type="hidden" name="toggle_name" value="" id="toggle_update_form__toggle_name" />
  <input type="hidden" name="toggle_value" value="" id="toggle_update_form__toggle_value" />
</form>

{% endblock %}

{% block scripts %}
<script src="/js/jquery/jquery-3.5.1.min.js" type="text/javascript"></script>
<script type="text/javascript">
    "use strict";

    (function ($) {
      var form_sent = false;

      function updateFeatureToggle(event) {
          $.ajax({
            method: "POST",
            url: '/api/feature/toggle',
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify({ 
              "feature_name": event.target.dataset["featureName"], 
              "value": event.target.checked
            })
          }).done(function( msg ) {
            M.toast({html: msg })
          }).fail(function(a, b, c) {
            M.toast({html: "An error has occurred" })
          }).always(function (a, b, c) {
          });
      }

      function postToggleUpdateForm(event) {
        console.debug("form_sent", form_sent);
        if (form_sent)
          return;

        var toggle_name = document.querySelector('#toggle_update_form__toggle_name');
        var toggle_value = document.querySelector('#toggle_update_form__toggle_value');
        toggle_name.value = event.target.dataset['featureName'];
        toggle_value.value = event.target.checked;
        document.getElementById("toggle_update_form").submit();
        form_sent = true;
      }

      // Need we figure out a better way refresh UI
      $(document).on("change", "input.toggle", updateFeatureToggle);
      
      // Kept for reference:
      // $(document).on("change", ".mdl-switch__input", postToggleUpdateForm);

    }(jQuery));

</script>
{% endblock %}