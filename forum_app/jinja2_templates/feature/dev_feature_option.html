{% extends "_layouts/_home.html" %}

{% block title %}Feature option{% endblock %}

{% block head_link %}<link rel="stylesheet" href="/css/mdl/material.min.css" />
<link rel="stylesheet" href="/css/mdl/material.min.css" />{% endblock %}

{% block content %}

<div class="page-content">

  <div class="container">

    <p class="work-in-progress">This is a work in progress.</p>
      
    <div class="action-panel" style="margin: 1em;">
      <!-- <a href="/feature/register" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect">Register</a> -->
      <form method="post" onsubmit="applyUpdates()" class="inline">
          <button class="btn waves-effect waves-light blue" type="submit" name="action" value="register">Register
            <i class="material-icons right">send</i>
          </button>
          <input type="hidden" id="updateIdList" name="feature_name" value="" />
      </form>
    </div>

  </div>

</div>

<form method="post" id="toggle_update_form">
  <input type="hidden" name="toggle_name" value="" id="toggle_update_form__toggle_name" />
  <input type="hidden" name="toggle_value" value="" id="toggle_update_form__toggle_value" />
</form>

{% endblock %}

{% block scripts %}
<script src="/js/jquery/jquery-3.5.1.min.js" type="text/javascript"></script>
<script type="text/javascript">
    "use strict";

    (function ($) {
      var form_sent = false;
      var snackbarContainer = document.querySelector('#notification-toast');

      function updateFeatureToggle(event) {
          $.ajax({
            method: "POST",
            url: '/api/feature/toggle',
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify({ 
              "feature_name": event.target.dataset["featureName"], 
              "value": event.target.checked
            })
          }).done(function( msg ) {
            snackbarContainer.MaterialSnackbar.showSnackbar({ message: msg });
          }).fail(function(a, b, c) {
            snackbarContainer.MaterialSnackbar.showSnackbar({ message: "An error has occurred" });
          }).always(function (a, b, c) {
          });
      }

      function postToggleUpdateForm(event) {
        console.debug("form_sent", form_sent);
        if (form_sent)
          return;

        var toggle_name = document.querySelector('#toggle_update_form__toggle_name');
        var toggle_value = document.querySelector('#toggle_update_form__toggle_value');
        toggle_name.value = event.target.dataset['featureName'];
        toggle_value.value = event.target.checked;
        document.getElementById("toggle_update_form").submit();
        form_sent = true;
      }

      // Need we figure out a better way refresh UI
      $(document).on("change", ".mdl-switch__input", updateFeatureToggle);
      
      // Kept for reference:
      // $(document).on("change", ".mdl-switch__input", postToggleUpdateForm);

    }(jQuery));

</script>
{% endblock %}